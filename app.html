<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>External App</title>
  <style type="text/css">
  html {
    background-color: green;
  }
  html,
  body {
    margin: 0;
    padding: 0;
  }
  .bloco {
    width: 100px;
    height: 100px;
    background-color: blue;
    overflow: hidden;
  }
  </style>
</head>

<body>
  <main role="main">
    <h1>External App</h1>
    <button type="button" id="add">Add</button>
    <button type="button" id="rm">Remove</button>
  </main>
  <script type="text/javascript">
  /* globals console */

  'use strict';

  // App stuff
  var cc = 0;
  var btnAdd = document.querySelector('#add');
  var btnRm = document.querySelector('#rm');

  btnAdd.addEventListener('click', function() {
    btnRm.insertAdjacentHTML('afterend', '<div class="bloco">' + cc + '</div>');
    cc++;
  }, false);

  btnRm.addEventListener('click', function() {
    var b = document.querySelector('.bloco');
    if (b) {
      b.remove();
      cc--;
    }
  }, false);
  // End App stuff

  // ---

  // postMessage
  var source, origin;
  var html = document.querySelector('html');
  var body = document.querySelector('body');
  var currentHeight = 0;
  var clientMsg = 'TExClient';

  function updateHeight() {
    var bodyBounds = body.getBoundingClientRect();
    var htmlBounds = html.getBoundingClientRect();
    return Math.max(htmlBounds.height, bodyBounds.height);
  }

  function envia(h) {
    if (source && origin) {
      source.postMessage(h, origin);
    }
  }

  function antesEnvia() {
    var h = updateHeight();
    if (currentHeight !== h) {
      currentHeight = h;
      envia(currentHeight);
    }
  }

  function recebe(event) {
    console.log('recebe', event.data);
    if (event.data === clientMsg) {
      origin = event.origin;
      source = event.source;
      envia(currentHeight);
    }
  }

  // Check if is Iframe
  if (window.self !== window.top) {

    console.log('is Iframe!!!', window.top.location.origin);

    window.addEventListener('message', recebe);
    window.parent.postMessage(
      JSON.stringify({
        'app': 'TExAppReady',
        'msg': clientMsg,
        'origin': window.location.origin
      }), window.parent.location.origin);

    // MutationObserver
    var mo = new MutationObserver(function(mutations) {
      console.log('MutationObserver-->', mutations[0].target.tagName + ' ' + mutations[0].type);
      antesEnvia();
    });

    var config = {
      childList: true,
      attributes: true,
      characterData: false,
      subtree: true,
      attributeOldValue: true,
      characterDataOldValue: false,
      attributeFilter: ['autocomplete']
    };

    mo.observe(body, config);

  } else {
    console.log('is not Iframe!!!');
  }
  </script>
</body>

</html>
